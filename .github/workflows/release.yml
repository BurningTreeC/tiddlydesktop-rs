name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      use_current_version:
        description: 'Use version from files (skip auto-increment). Set to true for major/minor releases like 0.2.0'
        required: false
        default: 'false'
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  increment-version:
    # Skip if this is a version bump commit from the bot, or a manual release commit
    # Manual release commits should start with "Release v" (e.g., "Release v0.2.0")
    # Always run for workflow_dispatch (manual trigger)
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (!contains(github.event.head_commit.message, 'Bump version to') &&
       !startsWith(github.event.head_commit.message, 'Release v'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      new_tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version and increment
        id: bump
        run: |
          # Get current version from Cargo.toml
          CURRENT_VERSION=$(grep '^version = ' src-tauri/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Check if we should use current version (for manual major/minor releases)
          if [ "${{ github.event.inputs.use_current_version }}" == "true" ]; then
            echo "Using current version from files (no auto-increment)"
            NEW_VERSION="$CURRENT_VERSION"
          else
            # Parse version components and increment patch
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          fi

          NEW_TAG="v${NEW_VERSION}"

          echo "New version: $NEW_VERSION"
          echo "New tag: $NEW_TAG"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-about
        run: cargo install cargo-about

      - name: Update version in all files
        if: github.event.inputs.use_current_version != 'true'
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"

          # Update Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" src-tauri/Cargo.toml

          # Update tauri.conf.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" src-tauri/tauri.conf.json

          # Update package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" package.json

          # Verify changes
          echo "=== Cargo.toml ==="
          grep '^version = ' src-tauri/Cargo.toml
          echo "=== tauri.conf.json ==="
          grep '"version"' src-tauri/tauri.conf.json
          echo "=== package.json ==="
          grep '"version"' package.json

      - name: Generate third-party licenses
        run: |
          cd src-tauri
          cargo about generate about.hbs > ../THIRD_PARTY_LICENSES.txt

          # Append bundled JS library licenses (html-to-image)
          sed 's/^            //' << 'LICENSES_EOF' >> ../THIRD_PARTY_LICENSES.txt

            ================================================================================

            BUNDLED JAVASCRIPT LIBRARIES
            =============================

            The following JavaScript libraries are bundled with TiddlyDesktop-RS
            in the resources/tdlib/ directory.

            ================================================================================

            ## html-to-image 1.11.11

            Used by: html-to-image DOM-to-image capture (https://github.com/bubkoo/html-to-image)

            License: MIT

            License text:

            MIT License

            Copyright (c) 2017-2025 W.Y.

            Permission is hereby granted, free of charge, to any person obtaining a copy
            of this software and associated documentation files (the "Software"), to deal
            in the Software without restriction, including without limitation the rights
            to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
            copies of the Software, and to permit persons to whom the Software is
            furnished to do so, subject to the following conditions:

            The above copyright notice and this permission notice shall be included in all
            copies or substantial portions of the Software.

            THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
            IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
            FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
            AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
            LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
            OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
            SOFTWARE.

            ================================================================================
          LICENSES_EOF

          echo "Generated THIRD_PARTY_LICENSES.txt (with html-to-image)"

      - name: Commit version bump and licenses
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add files that may have changed
          git add THIRD_PARTY_LICENSES.txt

          # Only add version files if we're auto-incrementing
          if [ "${{ github.event.inputs.use_current_version }}" != "true" ]; then
            git add src-tauri/Cargo.toml src-tauri/tauri.conf.json package.json
          fi

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Bump version to ${{ steps.bump.outputs.new_version }}"
            git pull --rebase
            git push
          fi

      - name: Create and push tag
        run: |
          # Check if tag already exists
          if git rev-parse "${{ steps.bump.outputs.new_tag }}" >/dev/null 2>&1; then
            echo "Tag ${{ steps.bump.outputs.new_tag }} already exists, skipping creation"
          else
            git tag ${{ steps.bump.outputs.new_tag }}
            git push origin ${{ steps.bump.outputs.new_tag }}
          fi

  build-linux:
    needs: increment-version
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout tiddlydesktop-rs
        uses: actions/checkout@v4
        with:
          path: tiddlydesktop-rs
          ref: ${{ needs.increment-version.outputs.new_tag }}

      - name: Checkout TiddlyWiki5
        uses: actions/checkout@v4
        with:
          repository: TiddlyWiki/TiddlyWiki5
          ref: v5.3.8
          path: TiddlyWiki5

      - name: Copy plugin to TiddlyWiki5
        run: |
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs-commands TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/codemirror-6-collab TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/editions/tiddlydesktop-rs TiddlyWiki5/editions/

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install npm dependencies
        working-directory: tiddlydesktop-rs
        run: npm install

      - name: Build TiddlyWiki
        working-directory: TiddlyWiki5
        run: |
          node tiddlywiki.js editions/tiddlydesktop-rs --output ../tiddlydesktop-rs/src --render '$:/core/save/all' 'index.html' 'text/plain'

      # Linux uses system Node.js - no bundled binary needed
      # Package dependencies (nodejs >= 18) are declared in tauri.conf.json

      - name: Bundle TiddlyWiki
        working-directory: tiddlydesktop-rs
        run: |
          mkdir -p src-tauri/resources
          rm -rf ../TiddlyWiki5/.git
          rm -rf ../TiddlyWiki5/editions/tiddlywiki-surveys
          cp -r ../TiddlyWiki5 src-tauri/resources/tiddlywiki
          cp src/index.html src-tauri/resources/index.html

      - name: Download PDFium
        working-directory: tiddlydesktop-rs
        run: |
          mkdir -p /tmp/pdfium-extract src-tauri/resources/tdlib
          curl -sL "https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-linux-x64.tgz" | tar xz -C /tmp/pdfium-extract
          cp /tmp/pdfium-extract/lib/libpdfium.so src-tauri/resources/tdlib/
          rm -rf /tmp/pdfium-extract

      - name: Build Tauri (Linux)
        working-directory: tiddlydesktop-rs
        run: npm run tauri build -- -c src-tauri/tauri.linux.conf.json

      - name: Build Arch Linux package
        working-directory: tiddlydesktop-rs
        run: ./scripts/build-arch-pkg.sh

      - name: Build portable tarball
        working-directory: tiddlydesktop-rs
        run: ./scripts/build-tarball.sh

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            tiddlydesktop-rs/src-tauri/target/release/bundle/deb/*.deb
            tiddlydesktop-rs/src-tauri/target/release/bundle/rpm/*.rpm
            tiddlydesktop-rs/src-tauri/target/release/bundle/arch/*.pkg.tar.zst
            tiddlydesktop-rs/target/tarball/*.tar.gz

  build-windows:
    needs: increment-version
    runs-on: windows-2022
    steps:
      - name: Enable long paths
        run: |
          git config --system core.longpaths true
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f

      - name: Checkout tiddlydesktop-rs
        uses: actions/checkout@v4
        with:
          path: tiddlydesktop-rs
          ref: ${{ needs.increment-version.outputs.new_tag }}

      - name: Checkout TiddlyWiki5
        uses: actions/checkout@v4
        with:
          repository: TiddlyWiki/TiddlyWiki5
          ref: v5.3.8
          path: TiddlyWiki5

      - name: Copy plugin to TiddlyWiki5
        shell: bash
        run: |
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs-commands TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/codemirror-6-collab TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/editions/tiddlydesktop-rs TiddlyWiki5/editions/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install npm dependencies
        working-directory: tiddlydesktop-rs
        run: npm install

      - name: Build TiddlyWiki
        working-directory: TiddlyWiki5
        shell: bash
        run: |
          node tiddlywiki.js editions/tiddlydesktop-rs --output ../tiddlydesktop-rs/src --render '$:/core/save/all' 'index.html' 'text/plain'

      - name: Download Node.js for bundling
        working-directory: tiddlydesktop-rs
        shell: bash
        run: |
          mkdir -p src-tauri/resources/binaries
          cd src-tauri/resources/binaries
          curl -L -o node.zip "https://nodejs.org/dist/v20.11.0/node-v20.11.0-win-x64.zip"
          unzip -q node.zip
          mv node-v20.11.0-win-x64/node.exe node.exe
          rm -rf node.zip node-v20.11.0-win-x64

      - name: Bundle TiddlyWiki
        working-directory: tiddlydesktop-rs
        shell: bash
        run: |
          mkdir -p src-tauri/resources
          rm -rf ../TiddlyWiki5/.git
          rm -rf ../TiddlyWiki5/editions/tiddlywiki-surveys
          cp -r ../TiddlyWiki5 src-tauri/resources/tiddlywiki
          # Copy index.html to resources for bundling (avoids WiX issues with map format)
          cp src/index.html src-tauri/resources/index.html

      - name: Download PDFium
        working-directory: tiddlydesktop-rs
        shell: bash
        run: |
          mkdir -p /tmp/pdfium-extract src-tauri/resources/tdlib
          curl -sL "https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-win-x64.tgz" | tar xz -C /tmp/pdfium-extract
          cp /tmp/pdfium-extract/bin/pdfium.dll src-tauri/resources/tdlib/
          rm -rf /tmp/pdfium-extract

      - name: Build Tauri (Windows)
        working-directory: tiddlydesktop-rs
        run: npm run tauri build -- --verbose -c src-tauri/tauri.windows.conf.json

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            tiddlydesktop-rs/src-tauri/target/release/bundle/msi/*.msi
            tiddlydesktop-rs/src-tauri/target/release/bundle/nsis/*.exe

  build-windows-no-nodejs:
    needs: increment-version
    runs-on: windows-2022
    steps:
      - name: Enable long paths
        run: |
          git config --system core.longpaths true
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f

      - name: Checkout tiddlydesktop-rs
        uses: actions/checkout@v4
        with:
          path: tiddlydesktop-rs
          ref: ${{ needs.increment-version.outputs.new_tag }}

      - name: Checkout TiddlyWiki5
        uses: actions/checkout@v4
        with:
          repository: TiddlyWiki/TiddlyWiki5
          ref: v5.3.8
          path: TiddlyWiki5

      - name: Copy plugin to TiddlyWiki5
        shell: bash
        run: |
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs-commands TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/codemirror-6-collab TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/editions/tiddlydesktop-rs TiddlyWiki5/editions/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install npm dependencies
        working-directory: tiddlydesktop-rs
        run: npm install

      - name: Build TiddlyWiki
        working-directory: TiddlyWiki5
        shell: bash
        run: |
          node tiddlywiki.js editions/tiddlydesktop-rs --output ../tiddlydesktop-rs/src --render '$:/core/save/all' 'index.html' 'text/plain'

      # No Node.js bundling - uses system Node.js like Linux builds

      - name: Bundle TiddlyWiki
        working-directory: tiddlydesktop-rs
        shell: bash
        run: |
          mkdir -p src-tauri/resources
          rm -rf ../TiddlyWiki5/.git
          rm -rf ../TiddlyWiki5/editions/tiddlywiki-surveys
          cp -r ../TiddlyWiki5 src-tauri/resources/tiddlywiki
          # Copy index.html to resources for bundling (avoids WiX issues with map format)
          cp src/index.html src-tauri/resources/index.html

      - name: Download PDFium
        working-directory: tiddlydesktop-rs
        shell: bash
        run: |
          mkdir -p /tmp/pdfium-extract src-tauri/resources/tdlib
          curl -sL "https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-win-x64.tgz" | tar xz -C /tmp/pdfium-extract
          cp /tmp/pdfium-extract/bin/pdfium.dll src-tauri/resources/tdlib/
          rm -rf /tmp/pdfium-extract

      - name: Build Tauri (Windows without bundled Node.js)
        working-directory: tiddlydesktop-rs
        run: npm run tauri build -- --verbose -c src-tauri/tauri.windows.no-nodejs.conf.json

      - name: Rename artifacts with PROVIDE_YOUR_OWN_NODEJS prefix
        working-directory: tiddlydesktop-rs
        shell: bash
        run: |
          # Rename MSI files
          for file in src-tauri/target/release/bundle/msi/*.msi; do
            if [ -f "$file" ]; then
              dir=$(dirname "$file")
              base=$(basename "$file")
              mv "$file" "$dir/PROVIDE_YOUR_OWN_NODEJS_$base"
            fi
          done
          # Rename NSIS exe files
          for file in src-tauri/target/release/bundle/nsis/*.exe; do
            if [ -f "$file" ]; then
              dir=$(dirname "$file")
              base=$(basename "$file")
              mv "$file" "$dir/PROVIDE_YOUR_OWN_NODEJS_$base"
            fi
          done

      - name: Upload Windows (no Node.js) artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-no-nodejs-artifacts
          path: |
            tiddlydesktop-rs/src-tauri/target/release/bundle/msi/*.msi
            tiddlydesktop-rs/src-tauri/target/release/bundle/nsis/*.exe

  build-macos:
    needs: increment-version
    runs-on: macos-latest
    steps:
      - name: Checkout tiddlydesktop-rs
        uses: actions/checkout@v4
        with:
          path: tiddlydesktop-rs
          ref: ${{ needs.increment-version.outputs.new_tag }}

      - name: Checkout TiddlyWiki5
        uses: actions/checkout@v4
        with:
          repository: TiddlyWiki/TiddlyWiki5
          ref: v5.3.8
          path: TiddlyWiki5

      - name: Copy plugin to TiddlyWiki5
        run: |
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs-commands TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/codemirror-6-collab TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/editions/tiddlydesktop-rs TiddlyWiki5/editions/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install npm dependencies
        working-directory: tiddlydesktop-rs
        run: npm install

      - name: Build TiddlyWiki
        working-directory: TiddlyWiki5
        run: |
          node tiddlywiki.js editions/tiddlydesktop-rs --output ../tiddlydesktop-rs/src --render '$:/core/save/all' 'index.html' 'text/plain'

      - name: Download Node.js for bundling (universal binary)
        working-directory: tiddlydesktop-rs
        run: |
          mkdir -p src-tauri/resources/binaries
          cd src-tauri/resources/binaries
          # Download for x64
          curl -L -o node-x64.tar.gz "https://nodejs.org/dist/v20.11.0/node-v20.11.0-darwin-x64.tar.gz"
          tar -xf node-x64.tar.gz
          mv node-v20.11.0-darwin-x64/bin/node node-x64
          rm -rf node-x64.tar.gz node-v20.11.0-darwin-x64
          # Download for arm64
          curl -L -o node-arm64.tar.gz "https://nodejs.org/dist/v20.11.0/node-v20.11.0-darwin-arm64.tar.gz"
          tar -xf node-arm64.tar.gz
          mv node-v20.11.0-darwin-arm64/bin/node node-arm64
          rm -rf node-arm64.tar.gz node-v20.11.0-darwin-arm64
          # Create universal binary using lipo
          lipo -create -output node node-x64 node-arm64
          rm node-x64 node-arm64
          chmod +x node

      - name: Bundle TiddlyWiki
        working-directory: tiddlydesktop-rs
        run: |
          mkdir -p src-tauri/resources
          rm -rf ../TiddlyWiki5/.git
          rm -rf ../TiddlyWiki5/editions/tiddlywiki-surveys
          cp -r ../TiddlyWiki5 src-tauri/resources/tiddlywiki
          # Copy index.html to resources for bundling
          cp src/index.html src-tauri/resources/index.html

      - name: Download PDFium
        working-directory: tiddlydesktop-rs
        run: |
          mkdir -p /tmp/pdfium-extract src-tauri/resources/tdlib
          curl -sL "https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-mac-univ.tgz" | tar xz -C /tmp/pdfium-extract
          cp /tmp/pdfium-extract/lib/libpdfium.dylib src-tauri/resources/tdlib/
          rm -rf /tmp/pdfium-extract

      - name: Add Rust targets for universal binary
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Build Tauri (macOS universal)
        working-directory: tiddlydesktop-rs
        run: npm run tauri build -- -c src-tauri/tauri.macos.conf.json --target universal-apple-darwin

      - name: Zip the .app bundle
        working-directory: tiddlydesktop-rs
        run: |
          cd src-tauri/target/universal-apple-darwin/release/bundle/macos
          for app in *.app; do
            zip -r "${app%.app}.app.zip" "$app"
          done

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            tiddlydesktop-rs/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
            tiddlydesktop-rs/src-tauri/target/universal-apple-darwin/release/bundle/macos/*.zip

  build-macos-no-nodejs:
    needs: increment-version
    runs-on: macos-latest
    steps:
      - name: Checkout tiddlydesktop-rs
        uses: actions/checkout@v4
        with:
          path: tiddlydesktop-rs
          ref: ${{ needs.increment-version.outputs.new_tag }}

      - name: Checkout TiddlyWiki5
        uses: actions/checkout@v4
        with:
          repository: TiddlyWiki/TiddlyWiki5
          ref: v5.3.8
          path: TiddlyWiki5

      - name: Copy plugin to TiddlyWiki5
        run: |
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs-commands TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/codemirror-6-collab TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/editions/tiddlydesktop-rs TiddlyWiki5/editions/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install npm dependencies
        working-directory: tiddlydesktop-rs
        run: npm install

      - name: Build TiddlyWiki
        working-directory: TiddlyWiki5
        run: |
          node tiddlywiki.js editions/tiddlydesktop-rs --output ../tiddlydesktop-rs/src --render '$:/core/save/all' 'index.html' 'text/plain'

      # No Node.js bundling - uses system Node.js like Linux builds

      - name: Bundle TiddlyWiki
        working-directory: tiddlydesktop-rs
        run: |
          mkdir -p src-tauri/resources
          rm -rf ../TiddlyWiki5/.git
          rm -rf ../TiddlyWiki5/editions/tiddlywiki-surveys
          cp -r ../TiddlyWiki5 src-tauri/resources/tiddlywiki
          # Copy index.html to resources for bundling
          cp src/index.html src-tauri/resources/index.html

      - name: Download PDFium
        working-directory: tiddlydesktop-rs
        run: |
          mkdir -p /tmp/pdfium-extract src-tauri/resources/tdlib
          curl -sL "https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-mac-univ.tgz" | tar xz -C /tmp/pdfium-extract
          cp /tmp/pdfium-extract/lib/libpdfium.dylib src-tauri/resources/tdlib/
          rm -rf /tmp/pdfium-extract

      - name: Add Rust targets for universal binary
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Build Tauri (macOS universal without bundled Node.js)
        working-directory: tiddlydesktop-rs
        run: npm run tauri build -- -c src-tauri/tauri.macos.no-nodejs.conf.json --target universal-apple-darwin

      - name: Zip the .app bundle and rename with prefix
        working-directory: tiddlydesktop-rs
        run: |
          cd src-tauri/target/universal-apple-darwin/release/bundle/macos
          for app in *.app; do
            zip -r "PROVIDE_YOUR_OWN_NODEJS_${app%.app}.app.zip" "$app"
            rm -rf "$app"
          done

      - name: Rename DMG with prefix
        working-directory: tiddlydesktop-rs
        run: |
          cd src-tauri/target/universal-apple-darwin/release/bundle/dmg
          for file in *.dmg; do
            if [ -f "$file" ]; then
              mv "$file" "PROVIDE_YOUR_OWN_NODEJS_$file"
            fi
          done

      - name: Upload macOS (no Node.js) artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-no-nodejs-artifacts
          path: |
            tiddlydesktop-rs/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
            tiddlydesktop-rs/src-tauri/target/universal-apple-darwin/release/bundle/macos/*.zip

  # Android build for CI validation only - APK is not included in GitHub releases
  # (Android app is distributed via Google Play Store)
  build-android:
    needs: increment-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tiddlydesktop-rs
        uses: actions/checkout@v4
        with:
          path: tiddlydesktop-rs
          ref: ${{ needs.increment-version.outputs.new_tag }}

      - name: Checkout TiddlyWiki5
        uses: actions/checkout@v4
        with:
          repository: TiddlyWiki/TiddlyWiki5
          ref: v5.3.8
          path: TiddlyWiki5

      - name: Copy plugin to TiddlyWiki5
        run: |
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/tiddlydesktop-rs-commands TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/plugins/tiddlywiki/codemirror-6-collab TiddlyWiki5/plugins/tiddlywiki/
          cp -r tiddlydesktop-rs/TiddlyWiki5/editions/tiddlydesktop-rs TiddlyWiki5/editions/

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;27.0.12077973"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Install system dependencies (for bindgen)
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev

      - name: Install npm dependencies
        working-directory: tiddlydesktop-rs
        run: npm install

      - name: Build TiddlyWiki
        working-directory: TiddlyWiki5
        run: |
          node tiddlywiki.js editions/tiddlydesktop-rs --output ../tiddlydesktop-rs/src --render '$:/core/save/all' 'index.html' 'text/plain'

      - name: Bundle TiddlyWiki
        working-directory: tiddlydesktop-rs
        run: |
          mkdir -p src-tauri/resources
          rm -rf ../TiddlyWiki5/.git
          rm -rf ../TiddlyWiki5/editions/tiddlywiki-surveys
          cp -r ../TiddlyWiki5 src-tauri/resources/tiddlywiki
          cp src/index.html src-tauri/resources/index.html

      - name: Build Tauri Android (arm64-v8a)
        working-directory: tiddlydesktop-rs
        run: |
          NDK=$ANDROID_NDK_HOME
          export NDK_HOME=$NDK
          export CC_aarch64_linux_android=$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang
          export CXX_aarch64_linux_android=$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang++
          export AR_aarch64_linux_android=$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
          export BINDGEN_EXTRA_CLANG_ARGS_aarch64_linux_android="--sysroot=$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot -I$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include -I$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include/aarch64-linux-android"
          npm run tauri android build -- --target aarch64

      - name: Find and rename APK
        working-directory: tiddlydesktop-rs
        run: |
          mkdir -p android-artifacts
          find src-tauri/gen/android -name "*.apk" -exec cp {} android-artifacts/ \;
          ls -la android-artifacts/

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: tiddlydesktop-rs/android-artifacts/*.apk

  create-release:
    needs: [increment-version, build-linux, build-windows, build-windows-no-nodejs, build-macos, build-macos-no-nodejs]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout (for license file)
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.increment-version.outputs.new_tag }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          # Find all release files and generate checksums
          find . -type f \( -name "*.deb" -o -name "*.rpm" \
            -o -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.zip" \
            -o -name "*.pkg.tar.zst" -o -name "*.tar.gz" \) \
            -exec sha256sum {} \; | \
            sed 's|  \./|  |' | sort -k2 > ../CHECKSUMS-SHA256.txt
          cat ../CHECKSUMS-SHA256.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.increment-version.outputs.new_tag }}
          name: TiddlyDesktopRS ${{ needs.increment-version.outputs.new_tag }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.pkg.tar.zst
            artifacts/**/*.tar.gz
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.zip
            CHECKSUMS-SHA256.txt
            THIRD_PARTY_LICENSES.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
